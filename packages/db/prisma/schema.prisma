generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String       @id @default(uuid())
  username String?      @unique
  name     String?
  email    String       @unique
  provider AuthProvider
  password String?

  // Ratings
  rating          Int @default(1200)
  puzzleRating    Int @default(1200)
  blitzRating     Int @default(1200)
  rapidRating     Int @default(1200)
  bulletRating    Int @default(1200)
  classicalRating Int @default(1200)

  // Profile
  avatar  String?
  bio     String?
  country String?
  title   String? // GM, IM, FM, etc.

  // Statistics
  gamesAsWhite Game[] @relation("GamesAsWhite")
  gamesAsBlack Game[] @relation("GamesAsBlack")
  wins         Int    @default(0)
  losses       Int    @default(0)
  draws        Int    @default(0)
  totalGames   Int    @default(0)

  // Timestamps
  createdAt DateTime  @default(now())
  lastLogin DateTime?

  // Social
  friendsInitiated Friendship[] @relation("FriendshipInitiator")
  friendsReceived  Friendship[] @relation("FriendshipReceiver")
  sentMessages     Message[]    @relation("MessageSender")
  receivedMessages Message[]    @relation("MessageReceiver")
  clubMemberships  ClubMember[]

  // Tournaments
  tournamentParticipations TournamentParticipant[]

  // Puzzles
  puzzleAttempts PuzzleAttempt[]

  // Achievements
  achievements UserAchievement[]

  // Annotations
  annotations GameAnnotation[]

  // Notifications
  notifications Notification[]

  // Phase 1: Advanced Features
  emotionalAnalytics EmotionalAnalytics[]
  cognitiveSessions  CognitiveSession[]
  playingStyleDNA    PlayingStyleDNA?
  adaptivePuzzleSets AdaptivePuzzleSet[]
  careerProgress     CareerProgress?
  aiCoachInsights    AICoachInsight[]
  blunderClusters    BlunderCluster[]

  // Settings
  isPublic            Boolean @default(true)
  allowFriendRequests Boolean @default(true)
  showOnlineStatus    Boolean @default(true)

  @@index([rating])
  @@index([username])
  @@index([puzzleRating])
}

model Game {
  id            String      @id @default(uuid())
  whitePlayerId String
  blackPlayerId String
  whitePlayer   User        @relation("GamesAsWhite", fields: [whitePlayerId], references: [id])
  blackPlayer   User        @relation("GamesAsBlack", fields: [blackPlayerId], references: [id])
  status        GameStatus
  result        GameResult?
  timeControl   TimeControl
  startingFen   String      @default("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")
  currentFen    String?
  startAt       DateTime    @default(now())
  endAt         DateTime?
  moves         Move[]
  opening       String?
  event         String?

  // Tournament
  tournamentId String?
  tournament   Tournament? @relation(fields: [tournamentId], references: [id])
  roundNumber  Int?

  // Variant
  variant GameVariant @default(STANDARD)

  // Metadata
  whiteTimeRemaining Int?
  blackTimeRemaining Int?
  increment          Int? @default(0)

  // Analysis
  annotations GameAnnotation[]

  // Statistics
  whiteAccuracy  Float?
  blackAccuracy  Float?
  brilliantMoves Int?   @default(0)
  blunders       Int?   @default(0)

  @@index([status, result])
  @@index([tournamentId])
  @@index([whitePlayerId])
  @@index([blackPlayerId])
}

model Move {
  id         String   @id @default(uuid())
  gameId     String
  game       Game     @relation(fields: [gameId], references: [id])
  moveNumber Int
  from       String
  to         String
  comments   String?
  before     String
  after      String
  timeTaken  Int?     @default(0)
  createdAt  DateTime @default(now())
  san        String?

  @@index([gameId])
}

// ==================== TOURNAMENT SYSTEM ====================

model Tournament {
  id           String           @id @default(uuid())
  name         String
  description  String?
  format       TournamentFormat
  timeControl  TimeControl
  status       TournamentStatus @default(UPCOMING)
  maxPlayers   Int
  currentRound Int              @default(0)
  totalRounds  Int
  startDate    DateTime
  endDate      DateTime?
  createdAt    DateTime         @default(now())
  createdBy    String

  participants TournamentParticipant[]
  games        Game[]
  rounds       TournamentRound[]

  @@index([status])
  @@index([startDate])
}

model TournamentParticipant {
  id           String     @id @default(uuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  score        Float      @default(0)
  rank         Int?
  isActive     Boolean    @default(true)
  joinedAt     DateTime   @default(now())

  @@unique([tournamentId, userId])
  @@index([tournamentId])
  @@index([userId])
}

model TournamentRound {
  id           String     @id @default(uuid())
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id])
  roundNumber  Int
  startTime    DateTime?
  endTime      DateTime?

  @@unique([tournamentId, roundNumber])
  @@index([tournamentId])
}

// ==================== PUZZLE SYSTEM ====================

model Puzzle {
  id         String   @id @default(uuid())
  fen        String
  moves      String // Solution moves in UCI format
  rating     Int      @default(1500)
  themes     String[] // Array of theme tags
  popularity Int      @default(0)
  createdAt  DateTime @default(now())

  attempts PuzzleAttempt[]

  @@index([rating])
  @@index([themes])
}

model PuzzleAttempt {
  id        String   @id @default(uuid())
  puzzleId  String
  puzzle    Puzzle   @relation(fields: [puzzleId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  solved    Boolean
  timeSpent Int // in seconds
  attempts  Int      @default(1)
  createdAt DateTime @default(now())

  @@index([puzzleId])
  @@index([userId])
  @@index([solved])
}

// ==================== SOCIAL FEATURES ====================

model Friendship {
  id          String           @id @default(uuid())
  initiatorId String
  initiator   User             @relation("FriendshipInitiator", fields: [initiatorId], references: [id])
  receiverId  String
  receiver    User             @relation("FriendshipReceiver", fields: [receiverId], references: [id])
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  acceptedAt  DateTime?

  @@unique([initiatorId, receiverId])
  @@index([initiatorId])
  @@index([receiverId])
  @@index([status])
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  sender     User     @relation("MessageSender", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
}

model Club {
  id          String   @id @default(uuid())
  name        String
  description String?
  avatar      String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())

  members   ClubMember[]
  chatRooms ChatRoom[]

  @@index([name])
}

model ClubMember {
  id       String   @id @default(uuid())
  clubId   String
  club     Club     @relation(fields: [clubId], references: [id])
  userId   String
  user     User     @relation(fields: [userId], references: [id])
  role     ClubRole @default(MEMBER)
  joinedAt DateTime @default(now())

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
}

model ChatRoom {
  id        String   @id @default(uuid())
  name      String
  clubId    String?
  club      Club?    @relation(fields: [clubId], references: [id])
  createdAt DateTime @default(now())

  messages ChatMessage[]

  @@index([clubId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id])
  userId    String
  content   String
  createdAt DateTime @default(now())

  @@index([roomId])
  @@index([userId])
}

// ==================== ACHIEVEMENTS ====================

model Achievement {
  id          String  @id @default(uuid())
  name        String  @unique
  description String
  icon        String?
  category    String
  requirement String // JSON string describing requirements
  points      Int     @default(0)

  userAchievements UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  unlockedAt    DateTime    @default(now())
  progress      Int         @default(100)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

// ==================== ANNOTATIONS & MISC ====================

model GameAnnotation {
  id         String   @id @default(uuid())
  gameId     String
  game       Game     @relation(fields: [gameId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  moveNumber Int
  annotation String
  createdAt  DateTime @default(now())

  @@index([gameId])
  @@index([userId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
}

// ==================== ENUMS ====================

enum GameStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  TIME_UP
  PLAYER_EXIT
}

enum GameResult {
  WHITE_WINS
  BLACK_WINS
  DRAW
}

enum TimeControl {
  CLASSICAL
  RAPID
  BLITZ
  BULLET
}

enum AuthProvider {
  EMAIL
  GOOGLE
  GITHUB
  GUEST
}

enum GameVariant {
  STANDARD
  CHESS960
  THREE_CHECK
  KING_OF_THE_HILL
  CRAZYHOUSE
}

enum TournamentFormat {
  SWISS
  ROUND_ROBIN
  KNOCKOUT
  ARENA
}

enum TournamentStatus {
  UPCOMING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

enum ClubRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum NotificationType {
  FRIEND_REQUEST
  FRIEND_ACCEPTED
  GAME_INVITATION
  TOURNAMENT_STARTED
  TOURNAMENT_ROUND
  ACHIEVEMENT_UNLOCKED
  MESSAGE_RECEIVED
  CLUB_INVITATION
}

// ============================================
// PHASE 1: ADVANCED FEATURES
// ============================================

// Emotional & Cognitive Analytics
model EmotionalAnalytics {
  id        String   @id @default(uuid())
  userId    String
  gameId    String
  createdAt DateTime @default(now())

  // Tilt Detection
  tiltScore        Float   @default(0) // 0-100
  tiltTriggerMove  Int? // Move number where tilt started
  blundersInTilt   Int     @default(0)
  
  // Time Pressure Analysis
  avgMoveTimeMs    Int
  panicModeStart   Int? // Move number
  movesUnder10Sec  Int     @default(0)
  blundersUnder30s Int     @default(0)
  
  // Confidence Metrics
  confidenceScore  Float   @default(50) // 0-100
  overconfidentAt  Int? // Move number
  hesitationMoves  Int     @default(0)
  
  // Performance Correlation
  accuracyDrop     Float? // Percentage drop from baseline
  ratingChange     Int?

  @@index([userId])
  @@index([gameId])
  @@index([createdAt])
}

// Cognitive Performance Tracking
model CognitiveSession {
  id        String   @id @default(uuid())
  userId    String
  startTime DateTime @default(now())
  endTime   DateTime?

  // Focus & Stamina
  focusScore       Float   @default(100) // Degrades over time
  fatigueLevel     Float   @default(0) // 0-100
  optimalDuration  Int? // Minutes before fatigue
  
  // Decision Quality
  sharpnessScore   Float? // Based on move quality
  blunderRate      Float? // Blunders per game
  tacticalMisses   Int     @default(0)
  
  // Session Stats
  gamesPlayed      Int     @default(0)
  avgAccuracy      Float?
  peakPerformance  Int? // Game number with best performance

  @@index([userId])
  @@index([startTime])
}

// Playing Style DNA
model PlayingStyleDNA {
  id        String   @id @default(uuid())
  userId    String   @unique
  updatedAt DateTime @updatedAt

  // Aggression Metrics
  aggressionScore    Float   @default(50) // 0-100
  sacrificeRate      Float   @default(0)
  attackFrequency    Float   @default(0)
  
  // Risk Appetite
  riskScore          Float   @default(50) // 0-100
  gambitsPlayed      Int     @default(0)
  sharpPositions     Float   @default(0)
  
  // Tactical Preference
  tacticalComplexity Float   @default(50) // 0-100
  combinationRate    Float   @default(0)
  quietMoveRate      Float   @default(0)
  
  // Positional Play
  positionalScore    Float   @default(50) // 0-100
  pawnStructure      Float   @default(0)
  pieceActivity      Float   @default(0)
  
  // Time Management
  timeUsagePattern   String? // "blitz_lover", "slow_thinker", etc.
  avgMoveTime        Int?
  timeScrambles      Int     @default(0)
  
  // Opening Repertoire
  e4Frequency        Float   @default(0)
  d4Frequency        Float   @default(0)
  sicilianDefense    Float   @default(0)
  favoriteOpening    String?
  
  // Archetype
  styleArchetype     String? // "Tactician", "Positional", "Universal", etc.
  similarGrandmaster String? // "Plays like Tal", etc.

  @@index([userId])
}

// Weakness-Based Adaptive Puzzles
model AdaptivePuzzleSet {
  id          String   @id @default(uuid())
  userId      String
  createdAt   DateTime @default(now())
  
  // Weakness Analysis
  weaknessType    String // "endgame", "tactics", "opening", etc.
  targetRating    Int
  difficultyLevel Int // 1-10
  
  // ML-Generated
  generatedBy     String   @default("ml_model")
  clusteringData  Json? // Blunder patterns
  
  // Puzzles
  puzzleIds       String[] // Array of puzzle IDs
  completedCount  Int      @default(0)
  successRate     Float?
  
  // Adaptive Scaling
  currentDifficulty Int    @default(5)
  adjustmentFactor  Float  @default(1.0)

  @@index([userId])
  @@index([weaknessType])
}

// Career Mode
model CareerProgress {
  id        String   @id @default(uuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Progression
  currentLevel      Int      @default(1) // 1-20 (800-2400 rating)
  targetRating      Int      @default(1000)
  currentRating     Int      @default(800)
  
  // Story Progress
  chaptersCompleted Int      @default(0)
  currentChapter    String   @default("beginner")
  storylineChoices  Json? // Player decisions
  
  // AI Opponents Defeated
  defeatedOpponents String[] // AI personality IDs
  currentOpponent   String?
  
  // Tournaments
  tournamentsWon    Int      @default(0)
  sponsorships      String[] // Unlocked sponsors
  
  // Unlocks
  unlockedLessons   String[]
  unlockedThemes    String[]
  unlockedAvatars   String[]
  
  // Achievements
  careerAchievements String[]
  
  // Stats
  totalGamesPlayed  Int      @default(0)
  winRate           Float?
  fastestPromotion  Int? // Days to next level

  @@index([userId])
  @@index([currentLevel])
}

// AI Coach Insights
model AICoachInsight {
  id        String   @id @default(uuid())
  userId    String
  gameId    String
  moveNumber Int
  createdAt DateTime @default(now())

  // Insight Type
  insightType   String // "time_management", "blunder_warning", "pattern", etc.
  severity      String // "info", "warning", "critical"
  
  // Message
  message       String
  suggestion    String?
  
  // Context
  position      String // FEN
  evaluation    Float? // Centipawn evaluation
  bestMove      String?
  playerMove    String?
  
  // Real-time Flag
  isRealtime    Boolean @default(false)
  wasDisplayed  Boolean @default(false)

  @@index([userId])
  @@index([gameId])
  @@index([createdAt])
}

// Opening Research (Community-Driven)
model OpeningResearch {
  id        String   @id @default(uuid())
  opening   String // e.g., "Sicilian Defense, Najdorf"
  fen       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Community Data
  gamesPlayed      Int      @default(0)
  whiteWins        Int      @default(0)
  blackWins        Int      @default(0)
  draws            Int      @default(0)
  
  // Analysis
  popularMoves     Json // Move frequencies
  winningMoves     Json // Moves with best win rate
  aiEvaluation     Float?
  
  // AI Summary
  aiSummary        String?
  keyIdeas         String[]
  commonMistakes   String[]
  
  // Contributions
  contributorCount Int      @default(0)
  lastAnalyzedAt   DateTime?

  @@index([opening])
  @@index([fen])
  @@index([gamesPlayed])
}

// Blunder Clustering (ML)
model BlunderCluster {
  id        String   @id @default(uuid())
  userId    String
  createdAt DateTime @default(now())

  // Cluster Info
  clusterType      String // "hanging_pieces", "back_rank", "fork", etc.
  frequency        Int    @default(1)
  avgRatingLoss    Float
  
  // Pattern Data
  positionPatterns Json // Common FEN patterns
  movePatterns     Json // Common move sequences
  
  // ML Metadata
  embeddingVector  Json? // For similarity search
  confidence       Float @default(0)

  @@index([userId])
  @@index([clusterType])
}
